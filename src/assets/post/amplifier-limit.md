title: 运放限幅电路
category: 硬件设计
date: 2014-11-13
tag: [运放]
layout: post
toc: true

---

在各种控制系统中，PID控制器之后必然有一个限幅过程，对于数字控制器而言，不过只是两个if语句的事情；但对于模拟控制器而言，却要麻烦的多。简单点的会使用运放上下限来作为输出电压的限制，但是有少部分情况需要极其特殊的限制电压，本文主要内容就是如何使用运放和钳位二极管来实现任意电压的限幅。
<!--more-->

# 前言
在各种控制系统中，PID控制器之后必然有一个限幅过程，对于数字控制器而言，不过只是两个if语句的事情；但对于模拟控制器而言，却要麻烦的多。简单点的会使用运放上下限来作为输出电压的限制，但是有少部分情况，比如运放的供电电压是 *±15V* ，但是我想要将它的输出限制在 *-6V/+2V* ，这样一个不对称也不常见的电压中，总不可能单独给运放提供一个 *-6V/+2V* 的电源吧，这会让电路的复杂性陡然上升，二来是无法保证运放在这个电源供电下能正常工作。
前些日子在论坛中发现的一个电路，这个电路实在是很有意思，它使用钳位二极管非常巧妙的实现了运放的限幅，并且在限幅区间之间的精确度也并没有偏离多少，确实是有它的独到之处的。

# 电路拓扑
![带限幅功能的模拟PI控制器](/img/amplifier-limit/01.png)
上图就是限幅控制器的原始电路， *R_1_，C_1_，C_2_* 组成的反馈网络和运放和反向输入端的 *R_1_* 构成了一个PI控制器，而 *V_D1_，V_D2_，U_Q_，R_2_，R_3_* 则构成了一个限幅网络，限制控制器输出。
在此我们只重点对限幅部分进行分析，所以将电路简化，去掉积分电容，运放构成一个放大倍数为 1 的反向放大器。如下图：
![带限幅功能的反向放大器](/img/amplifier-limit/02.png)

## 电路参数
|描述|元件代号|值/型号|
|:---|:---:|---:|
|输入电阻和反馈电阻|R_1_|100kΩ|
|钳位分压电阻|R_2_|3kΩ|
||R_3_|1kΩ|
|直流偏置电压|U_Q_|15V|
|正向钳位二极管|VD_1_|1N4148|
|反向钳位二极管|VD_2_|1N4148|

# 简化分析
我们先对电路的原理做简要的分析，假设电路中都是理想器件，二极管关断时漏电流为0A，并且二极管开启电压为 *U_VD_ = 0.7V* 。
由于运放为理想运放，开环增益无穷大，内阻无穷大，所以虚短虚断成立，所以一定有：
$$
U_B = 0V
$$

## 输入电压为正
很明显的，此时VD_1_反偏，所以它截止，可以省略，电路化简为：
![输入电压为正时的电路化简](/img/amplifier-limit/03.png)
对于VD_2_，此时电路会因为它是否导通而产生不同的状态，所以再次分状态讨论。

### VD_2_关断
当VD_2_未导通的时候，由于运放虚短成立，所以B点接地，由U_Q_到A点到输出的电路支路由于没有接地的固定电位，所以对输出电压没有影响，亦可忽略。电路可进一步化简：
![VD_2_关断时的电路化简](/img/amplifier-limit/04.png)
电路简化为典型的反向放大器，所以有：
$$
U_{out}=-U_{in}
$$

### VD_2_导通
VD_2_导通，此支路进入反馈环路，它不能被忽略，电路图请参考图03。此时它两端的电压一定是开启电压，所以一定有：
$$
U_A=U_B-U_{VD}=-0.7V
$$
在VD_2_临界导通时，由U_Q_到A点到输出的电路支路实际上是分压电路，所以有：
$$
U_{out}=U_A- \frac{U_Q-U_A}{R_2}\cdot R_3=-5.933V
$$
此时输入电压为：$$U_{in}=-U_{out}=5.933V$$
当输入电压继续增大的时候，二极管随之导通，而此时A点电位被二极管钳位，固定在-0.7V，随之而来的就是输出电压也会被固定在-5.933V，不再随着输入电压变化而变化。
此值即为输出电压的最小值：-5.933V。

## 输入电压为负
输入为负电压，则输出一定为正，同样的U_A_也一定为正，所以VD_2_反偏截止，可以忽略。同时次支路由于没有固定电位，对输出没有影响，所以可以省略。电路可以化简为：
![输入为负电压时的电路化简](/img/amplifier-limit/05.png)
同样的，对于VD_1_，此时电路也会因为它是否导通而产生不同的状态，所以再次分状态讨论。

### VD_1_截止
此时情况和输入为负电压且VD_2_未导通时一样。电路同样可以简化为一个反向放大器，电路图参考图03。所以输入输出的关系为：
$$
U_{out}=-U_{in}
$$

### VD_1_导通
当VD_1_临界导通的时候，一定有：
$$
U_{out}-U_B=0.7V
$$
因为运放虚短成立，所以有：
$$
U_B=0V
$$
联立两式，解得：
$$
U_{out}=0.7V
$$
所以此时输入电压为：
$$
U_{in}=-U_{out}=-0.7V
$$

## 总结
由以上计算可以看出，对于输出而言，电压被限制在了-5.933V和0.7V之间，而在这之间，运放依然是工作于标准反向放大器模式下的。总结一下公式，我们就能看出，计算此电路限制的电压值的公式为：
$$
\left\{\begin{matrix}
U_{max}=U_{VD}\\ 
U_{min}=-U_{VD}-\frac{U_Q-U_{VD}}{R_2}\cdot R_3
\end{matrix}\right.
$$

从公式中我们可以看出限幅网路的计算和运放连同原本的反馈网络是没有关系的，所以在限制值之内运放不会受到任何影响，是非常有效和出色的电路。
若是工程应用的话，用上面的分析和计算的方法就已经足够，R_1_的大小可以不动，而R_2_和R_3_还有U_Q_共同决定了钳位电压。电路的变化还是比较简单的。

但是，只要仔细看看就会发现上面的简要分析有一个漏洞，那就是忽略了*二极管导通后的电流*。而在钳位电路中，钳位二极管流过的电流是一个非常重要的电路参数，这对于二极管的选择至关重要。而且，对于运放来说二极管钳位之后反馈是否还成立；作为反馈通路的一部分，钳位二极管流过的电流是以怎样的形式来影响输出的，这对于理解这个电路的原理还是很重要的。

# 详细分析
简要分析中主要是把二极管看作理想器件进行分析，现在将二极管看作非理想器件，即漏电流是存在的，二极管的电压电流特性是非线性的。

## 基本方程
![标注电流正方向的限幅电路](/img/amplifier-limit/06.png)
由于运放的虚断特性，忽略流入运放内部的电流。
对A、B两点，由基尔霍夫电流定理，有：
$$
\left\{\begin{matrix}
I_{in}=I_1+I_{VD1}+I_{VD2}\\ 
I_3=I_2+I_{VD2}
\end{matrix}\right.
$$
由欧姆定律可以得到有：
$$
\left\{\begin{matrix}
I_{in}=\frac{U_{in}}{R_1}\\ 
I_2=\frac{U_Q-U_A}{R_2}\\
\frac{U_A-U_{out}}{R_3}=\frac{U_Q-U_A}{R_2}+I_{VD2}
\end{matrix}\right.
$$
联立上述两个方程组，可以得到：
$$
\left\{\begin{matrix}
U_{out}=-U_{in}+R_1*(I_{VD1}+I_{VD2})\\ 
U_A=\frac{I_{VD2}\cdot R_2\cdot R_3+R_2\cdot U_{out}+R_3\cdot U_Q}{R_2+R_3}
\end{matrix}\right.
$$

## 二极管的非线性建模
二极管的建模，在这里是对二极管的伏安特性建模，以取得更精确的方程来描述二极管在开通过程中的状态。二极管即PN结的电流方程为：
$$
I=I_s\cdot (e^{\frac{U}{n\cdot u_T}}-1)
$$
其中， *u_T_ = 26mV* 。
二极管的伏安特性曲线可以在具体的*datasheet*中查到，这里假定选用 *1N4148*。带入方程，解出待定系数，方程化解为：
$$
I=3.673\cdot (e^{\frac{U}{92.846mV}}-1)\cdot 10^{-6}A
$$
据此我们可以绘制出伏安特性曲线：
![二极管正偏时的伏安特性曲线](/img/amplifier-limit/07.png)
二极管在反偏的时候，电流在很大的电压范围内变化很小，可以视作一个常数：*I = 25nA*。
综上所述，二极管的非线性方程可以表示为：
$$
\left\{\begin{matrix}
I=3.673\cdot (e^{\frac{U}{92.846mV}}-1)\cdot 10^{-6}A&U_{VD}> 0V\\ 
I=25nA&U_{VD}< 0V
\end{matrix}\right.
$$

## 电路分析
由二极管的非线性建模我们可以看出，电路以两个二极管两端电压正负为区分，输入电压由负到正可以分为3个状态（两个二极管都反偏的情况是不存在的）。
* VD_1_正偏，VD_2_反偏
* VD_1_反偏，VD_2_反偏
* VD_1_反偏，VD_2_正偏

### VD_1_正偏，VD_2_反偏
此时 *U_in_ < 0V*，*U_out_ > 0V* 。并且由于VD_2_反偏，所以有 *I_VD2_ = -25nA*。输入输出满足方程组：
$$
\left\{\begin{matrix}
U_{out}=-U_{in}+R_1\cdot (I_{VD1}+I_{VD2})\\ 
-I_{VD1}=3.673\cdot (e^{\frac{U_{out}}{92.846mV}}-1)\cdot 10^{-6}A
\end{matrix}\right.
$$
其中I_VD1_为负值是因为两者电流方向与图06中相反。
很明显方程组是没有解析解的，将 *0V 〜 -15V* 区间离散化，带入方程中求数值解，可以得到曲线图：
![输入为负电压时输入与输出的关系](/img/amplifier-limit/08.png)
从图中可以看出，随着输入电压的不断下跌，输出电压往上升的趋势越来越放缓，运放一般来说的供电电压是±15V,可以看到当输入电压达到最小的-15V时，输出电压为0.35V，输出电压被钳位，而输出电流则是随着电压线性上升的。

### VD_1_反偏，VD_2_反偏
两个二极管都反偏，说明输出在正常的范围中，没有被限制。根据一般方程，可以得到：
$$
U_{out}=-U_{in}+R_1\cdot (I_{VD1}+I_{VD2})
$$
其中 *I_VD1_ = I_VD2_ = -25nA*，所以方程可以化简为：
$$
U_{out}=-U_{in}+5mV
$$
此时输出电压也并不是和输入电压呈现完全的反向放大器的特性，有一定的**误差**，这个误差大小是由两个二极管的**漏电流**共同决定的。
很明显，当VD_2_正偏的时候这个状态结束。而当VD_2_临界正偏的时候，一定有：
$$
0V=\frac{I_{VD2}\cdot R_2\cdot R_3+R_2\cdot U_{out}+R_3\cdot U_Q}{R_2+R_3}
$$
方程解得：
$$
\left\{\begin{matrix}
U_{out}=-5V\\ 
U_{in}=5.005V
\end{matrix}\right.
$$

### VD_1_反偏，VD_2_正偏
此时 *U_in_ > 5.005V*，*U_out_ < -5V*。并且由于VD_1_反偏，所以有 *I_VD1_ = -25nA*。输入输出满足方程组：
$$
\left\{\begin{matrix}
U_{out}=-U_{in}+R_1\cdot (I_{VD1}+I_{VD2})\\ 
U_A=\frac{I_{VD2}\cdot R_2\cdot R_3+R_2\cdot U_{out}+R_3\cdot U_Q}{R_2+R_3}\\
I_{VD2}=3.673\cdot (e^{\frac{-U_{A}}{92.846mV}}-1)\cdot 10^{-6}A
\end{matrix}\right.
$$
方程依旧没有解析解，将 *5V〜15V* 区间中的电压离散，带入方程中求数值解，求解得到：
![VD_2_正偏时输入与输出的关系](/img/amplifier-limit/09.png)
从图中可以看出，随着输入电压的不断上升，输出电压下降的趋势越来越放缓，当输入电压达到最大的15V时，输出电压为-5.5V，输出电压被钳位，而输出电流也是随着电压线性上升的。

## 环路分析
到此时，电路的建模已经完成了，钳位二极管的工作状态也已经明了了，但是似乎还欠缺一个地方——上面的计算中其实都是默认为运放的虚短是成立的，电路的负反馈也是成立的。但是真的是如此吗？

这个电路的基本是运放的反向放大电路。先看看最基本的电路，其反馈是如何工作的。
![反向放大电路](/img/amplifier-limit/10.png)
从分类上来讲，反向放大器是属于电压并联型的反馈组态。即是说——反馈量取自输出电压，且将其转换为反馈电流 I_f_，并将之与输入电流 I_in_求差后放大。
虽然反馈量是取自输出电压，但是我们可以直接将反馈量看作是电流，这也是并联型的特点。（并联型即是指输入与反馈是以电流形式叠加）。将之改为控制模型图示：
![并联型反馈的控制模型](/img/amplifier-limit/11.png)
从控制系统的图示中，可以很明显的看出反向放大器的工作方式——
* 假设 *I_in_* 增大，则有 *I_e_* ↑ →  *U_out_* ↑ →  *I_f_* ↑ →  *I_e_* ↓……
* 假设 *I_in_* 减小，则有 *I_e_* ↓ →  *U_out_* ↓ →  *I_f_* ↓ →  *I_e_* ↑……

很明显可以看出，并联型的是反馈电流和输入电流做差得到误差量，使得误差量逼近于零。而此时，所谓误差量在电路中体现为运放的输入电流 I_e_，这个值约等于零，就说明运放的正负倒相端之间的压差也几乎为零了，此时虚短成立。
而在反馈过程中输出电压在环路中只是输出量，并不直接参与反馈。标准的反向放大器的反馈网络是纯电阻，也就是说反馈函数是一个常数（线性的），那么整个系统的传递函数也体现出线性特性。
回到这个限幅电路中，反馈网络并不是电阻，还包含了二极管这样的非线性器件，那么必然导致输出电压和反馈电压呈现出非线性的特性，从而影响到整个环路。
先从反馈的角度上来看限幅电路，假设VD_2_反偏，VD_1_正偏，为了方便分析，忽略反偏的VD_2_。此时一定有：*U_in_ < 0V*、*U_out_ > 0V* 。
![忽略VD2的限幅电路](/img/amplifier-limit/12.png)
事实上，仔细看看就会明白，虽然二极管是非线性器件，但是趋势是和纯电阻是一样的，随着正向电压的增大，正向电流也同样增大。所以这个电路反馈的过程实际上和纯电阻反馈是一样的。唯一不同的就是二极管的变化。从二极管的伏安特性曲线（图07）中看出，随着电压的上升，在达到开启电压附近的时候，二极管的电流陡然上升，我们可以等效的理解为，未到达开启电压的时候二极管的阻抗非常大，到达开启电压附近之后二极管的阻抗迅速减小。
二极管的这一特性带来的结果就是，输入电压很低的时候，二极管的阻抗很大，I_VD1_非常小，反馈环路中起主导作用的是 I_1_，这也是为什么低压的时候输出和输入保持着反向放大器特性的原因。当输入电压增大，二极管两端电压到达开启电压之后，二极管的阻抗迅速降低，I_VD1_迅速增大，成为了反馈环路中起主导作用的部分。从二极管的伏安特性曲线中可以看出，二极管开启后，即便电流变化很大，而电压变化却非常小。环路需要增大输出电压来增加反馈电流，使得误差电流趋于零，而二极管的这一特性，使得只需要增加一点点输出电压就能提供足够的反馈电流了，这也是为什么输出电压被钳制的原因所在。

**并联型反馈的核心是电流，输出电压只是系统稳定之后的一个表现。**

回过头来看看 *虚短* 。虚短成立的条件实际上很简单——
> 1. 运放的开环增益A要足够大
> 2. 要有负反馈电路

为什么说运放的开环增益一定要足够大？设反馈网络的等效电阻为R_f_，输入电阻为R_i_，运放的开环增益为A。对于电压并联型反馈，输出电压与输入电压之比为：
$$
\frac{U_{out}}{U_{in}}=-\frac{1}{\frac{R_i}{A}+\frac{R_i}{R_f}}
$$
一般而言，当A趋向于无穷大的时候，$$\frac{R_i}{A}$$可以忽略不计，等式变化为：
$$
\frac{U_{out}}{U_{in}}=-\frac{R_f}{R_i}
$$
即标准的反向放大器的输入输出公式。$$\frac{R_i}{A}$$被忽略，其实就意味着忽略了误差量，虚短成立。很明显，当R_f_与A很接近的时候，误差量就不能被忽略，虚短就不能成立。
实际中运放的开环增益大概都是 *10^6^〜10^8^* ，甚至更高。另外，在这个电路中，反馈网络中始终有一个R_1_的反馈电阻存在，使得整个反馈网路的等效电阻只会小于R_1_，而不会大于。而且R_1_是远小于A的，所以这个电路的虚短是一直成立的。

# Matlab仿真
按照惯例，用Matlab仿真电路啦~
下图是仿真模型图，引出两个波形，一个是正常的反向放大器，一个是这次的限幅电路。输入为频率 *1kHz* 、幅值 *10V* 的正弦波。
![Matlab仿真模型](/img/amplifier-limit/13.png)
![Matlab仿真输出波形图](/img/amplifier-limit/14.png)
黄色为正常的反向放大器输出，紫色的是限幅电路的输出。左图是整个周期的波形，右图是未限幅的区间内的误差。仿真的结果和计算是基本吻合的。

# 总结
这次的限幅电路是个很有趣的电路，钳位二极管这么玩很有意思。总结一下这次的要点：
1. 电路中虚短和虚短都是成立的，运放工作在电压并联反馈状态
2. 电路和正常的反向放大有一定误差，这个误差由二极管的漏电流和输入电阻决定
3. 流经二极管的电流越大，限幅的效果越好（凸起越小），但是这又会增加电路的功耗，在实际运用中需要看你对误差的接受程度来决定
4. 如果器件选取的合适，理论上这个电路可以实现任意电压的限幅