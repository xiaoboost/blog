---
title: 博客新架构说明
create: 2022/05/15
description: 如你所见，这又是篇介绍我怎么折腾博客架构的文章。
---

博客里文章没几篇，但是博客架构被我前前后后折腾四五次了~~捂脸~。
这篇文章主要是记录一下这次新架构被我折腾成啥样了，一方面也是好久没写~~懒狗~~文章了，来水一篇博文。

# 概述

## 名词说明

脚本
样式
模板

## 早期版本

在最初的**1.0**博客架构中，采用的是最传统的结构，即——PUG 模板+样式+脚本+其他资源的方式，所有内容其实都是分开写的，依靠着各种很弱的“约定规则”来达成不同资源、数据、变量的引用和共享，虽然这种形式是可以完成目的的，但是写起来非常烦人，各种约定的规则都能单独记一个文件，每次我要写文章，或者是改动某个配置，都要先看看这个规则文件，然后看有没有改错某个路径，非常的不方便。

这个架构没多久就被我抛弃了，然后是之后的**2.0**版本，这个版本我采用了当时比较流行的`Vue`框架，借助通用的`Webpack`编译工具实现了各种静态资源的随意引用，网站也改为了单页应用的形式。但是编译虽然是方便了，但是最终的效果没能达成我自己的要求。单页应用有两个问题，产物太大了，首屏效果不好。这两点都很好理解，单页应用的编译流程里，它会把 Vue 等库全部打包进产物中，并且在首屏它是会先实例化 Vue，然后再去渲染，是完不成首屏直出的效果的。另外还有个问题是，即便是用了 Vue 框架，还是无法实现样式、脚本、模板三者的变量共享。
另外，这个版本的 md 解析器使用的是我个人修改的[`marked`](https://github.com/xiaoboost/blog/blob/1.0/lib/marked.js)工具，这个解析器的优势是小巧，但是也有个很严重的问题，就是太麻烦了。我想要加个数学公式的组件，想要加个复杂的显示效果，都必须要去改解析器来识别，非常的麻烦。
为了改进以上这几个问题，我又进行了次重构，这就是后来的**3.0**版本。

**3.0**版本的博客，因为这时候我工作的原因，于是我又更换了了`React`库，又为了更好的管理博客的结构，使用了`monorepo`的形式，并且最后发现构建流程并不复杂，其实也不需要`Webpack`，于是干脆把它也去掉了。模板部分就完全用`TSX`来写，脚本部分同样用`TS`来写，这样就很方便的实现了模板和脚本的变量共享。对于**样式**，我选用了[`JSS`](https://cssinjs.org/)这个库，这个库是非常直观的结构化样式描述方式，并且也是可以用`TS`来写的，自此，样式、脚本、模板三者的变量共享就算是解决了。模板的产物 HTML 文件就依靠`React`的`SSR`功能来完成。像是字体一样的静态资源，就模仿`Webpack`的加载方式，暴露给脚本的是最终路径，而在构建中移动它的位置即可。对于解析器的问题，这次我更换了[`MDX`](https://mdxjs.com/)，顾名思义，这个就是允许用户直接在 md 文件中写`React`，乃至于引用写好的各种组件，非常方便。

到此为止，似乎看起来还挺好的，其实不然，这里还是有几个问题：

1. 我为了从产物里去掉`Vue`，都放弃单页应用了，我怎么能忍受`JSS`被打包到产物里面去，而且这东西本质上仍然是脚本，首屏是没有样式的。
2. `JSS`中引用了另一个样式文件（`@import`形式），若是这个样式文件里还有静态资源（比如字体），此时是无法识别的，因为这个`JSS`本质上是脚本，解析器无法递归的去解析里面的样式文件具体是什么。
3. 采用了 Monorepo 之后，若是每个包/组件都被迫单独编译，调试的时候实在是痛苦，因为我需要开两个线程，一个是主构建流程，还有一个是当前正在修改/调试的组件库，实在是麻烦。
4. `MDX`是很方便，但是在构建过程中，我们需要把所有组件的静态资源都全部打包到一起吗？比如`katex`数学公式库，这个库的样式+字体的体积特别大，如果打包到整体的样式文件中，每次打开网站都要一起加载，这实在是不怎么**优雅**。

## 当前版本

前言已经说的太多了，终于说到了现在的**4.0**版本了。没错，这个版本就是为了解决上述 4 个问题才诞生的，基本上而言，这个版本我觉得拿来做日常使用已经没有什么大问题了，剩下还有些诸如构建不够快，错误提示不够明显之类的问题，都是不需要变更架构的小问题。

5. 变量共享
6. 这次博客的新架构，有三个核心理念：
7. 全 JS，既是指整个博客全部是 JS/TS 代码，连样式文件
