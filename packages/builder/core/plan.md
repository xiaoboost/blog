整个编译流程是这样的：

1. 代码打包

完成之后运行整个打包流程

2. 组件 ready

- 开始编译
- 部分组件需要提前准备
- 这部分在开始编译的时候即可

3. 文章组件空运行

- 部分组件需要预载

4. 获取文章页面路径

- 生成文件到网址的映射

5. 生成所有组件的静态资源

- 生成文件到路径的枚举对象

6. 渲染文章页面

- 5.1 模板之类的放在那里？是作为插件吗？还是写在 builder 里面

7. 渲染其他页面

代码分为好几个层级：

用于渲染的组件/模板代码
用于生成网站的代码
打包器本身代码
cli 代码

四个层级

现在的问题：

1. 模板和组件“约定”的函数写起来不方便，还容易写错
2. 打包的代码分割问题
3. 注入的全局变量的管理
4. 类型提示代码框，需要有类型注入，但是不能直接在
   这个的话，可以采用文章里提供类型库的注解，然后在代码框组件渲染前，npm install，但是耗时问题需要再研究一下

那么问题来了，整个构建分为了 2 步，打包代码和运行代码
后者运行函数时，钩子的运行怎么注入比较好？

那么将注册钩子的函数注入全局，然后模板或者组件自己注册？
模板注册的钩子，和它自身导出的渲染函数，应该是分开的

createAssets 可以是钩子，最后生成静态数据的时候用
但是 getAssetNames 怎么办，生成名字，也可以是钩子吧……组件渲染必然在 post 渲染的前面，那个时候已经生成了名称了

那么后面 post 渲染的时候，这些值怎么塞进去呢

钩子表明的是在编译的什么时候执行这些内容，但是还有其他的方法，是需要在渲染的时候不断手动调用的方法
这些 api 如何统一起来

1. 首先固定的是，每个组件或/模板，默认导出就是那个默认的渲染函数，然后是其他导出 styles 之类的，还有一些变量方法之类的
2. 需要定义钩子，这个需要固定导出一个函数，那么问题来了，这么写的话………不还是成了“约定”，所以这里不能导出一个函数，必须要用全局函数注册
3. 在整个流程里面，除开渲染函数，还有一个是 getAssetNames 函数，这个函数也是必须的，但是你不能用“约定”去约束它
4. 每个模板/组件都会生成静态资源的，但是只有部分需要提取出来，这部分是写死的

所以这里需要，一个 types 库，里面定义所有类型，还有 define 函数
core 库，定义所有的流程
cli 库作为外部引用指令的操作
context 作为注入的所有全局变量导出，注入的运行时变量全在这里，一共包含：

- jss
- define 函数
- getGlobal param 缓存
- 文件缓存

毕竟是注入的，这里就必须还要包含生成代码的内容，即生成字符串代码的部分

还有个问题，钩子分两种，bundle 钩子和 build 钩子，build 钩子是一次性的，watch 一次就会重新用，但是 bundle 钩子不是，它是打包流程中的
那么问题来了，build 钩子是只有运行的时候才能拿到的，这两种插件应该是要分开的
